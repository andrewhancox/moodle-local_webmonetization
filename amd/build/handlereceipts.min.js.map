{"version":3,"sources":["../src/handlereceipts.js"],"names":["define","ajax","init","requiremonetization","wantsurl","document","monetization","addEventListener","event","req","call","methodname","args","receipt","detail","contextid","M","cfg","redirecturl","wwwroot","done","result","window","location","href","fail"],"mappings":"AAyBAA,OAAM,wCAAC,CAAC,WAAD,CAAD,CAAgB,SAAUC,CAAV,CAAgB,CAClC,MAAO,CAOHC,IAAI,CAAE,cAAUC,CAAV,CAA+BC,CAA/B,CAAyC,CAC3C,GAAIC,QAAQ,CAACC,YAAb,CAA2B,CACvBD,QAAQ,CAACC,YAAT,CAAsBC,gBAAtB,CAAuC,sBAAvC,CAA+D,SAAAC,CAAK,CAAI,CACpE,GAAIC,CAAAA,CAAG,CAAGR,CAAI,CAACS,IAAL,CAAU,CAChB,CACIC,UAAU,CAAE,qCADhB,CACuDC,IAAI,CAAE,CACrDC,OAAO,CAAEL,CAAK,CAACM,MAAN,CAAaD,OAD+B,CAErDE,SAAS,CAAEC,CAAC,CAACC,GAAF,CAAMF,SAFoC,CAD7D,CADgB,CAAV,CAAV,CASA,GAAIZ,CAAJ,CAAyB,CACrB,GAAIe,CAAAA,CAAW,CAAGF,CAAC,CAACC,GAAF,CAAME,OAAN,CAAgB,oDAAhB,CAAuEH,CAAC,CAACC,GAAF,CAAMF,SAA/F,CACAN,CAAG,CAAC,CAAD,CAAH,CAAOW,IAAP,CAAY,SAAUC,CAAV,CAAkB,CAC1B,GAAI,KAAAA,CAAJ,CAAqB,CACjBC,MAAM,CAACC,QAAP,CAAgBC,IAAhB,CAAuBN,CAC1B,CAFD,IAEO,IAAId,CAAJ,CAAc,CACjBkB,MAAM,CAACC,QAAP,CAAgBC,IAAhB,CAAuBpB,CAC1B,CACJ,CAND,EAMGqB,IANH,CAMQ,UAAY,CAChBH,MAAM,CAACC,QAAP,CAAgBC,IAAhB,CAAuBN,CAC1B,CARD,CASH,CACJ,CAtBD,CAuBH,CAxBD,IAwBO,IAAIf,CAAJ,CAAyB,CAC5B,GAAIe,CAAAA,CAAW,CAAGF,CAAC,CAACC,GAAF,CAAME,OAAN,CAAgB,8CAAhB,CAAiEH,CAAC,CAACC,GAAF,CAAMF,SAAzF,CACAO,MAAM,CAACC,QAAP,CAAgBC,IAAhB,CAAuBN,CAC1B,CACJ,CApCE,CAsCV,CAvCK,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @package local_webmonetization\n * @author Andrew Hancox <andrewdchancox@googlemail.com>\n * @author Open Source Learning <enquiries@opensourcelearning.co.uk>\n * @link https://opensourcelearning.co.uk\n * @link https://webmonetization.org\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @copyright 2021, Andrew Hancox\n */\n\ndefine(['core/ajax'], function (ajax) {\n    return {\n        /**\n         * Factory method returning instance of the handlereceipts\n         *\n         * @return {handlereceipts}\n         */\n        // switch to using timer, 60 seconds but reset each time a monetizationprogress fires successfully.\n        init: function (requiremonetization, wantsurl) {\n            if (document.monetization) {\n                document.monetization.addEventListener('monetizationprogress', event => {\n                    var req = ajax.call([\n                        {\n                            methodname: 'local_webmonetization_handlereceipt', args: {\n                                receipt: event.detail.receipt,\n                                contextid: M.cfg.contextid\n                            }\n                        }\n                    ]);\n\n                    if (requiremonetization) {\n                        var redirecturl = M.cfg.wwwroot + '/local/webmonetization/interstitial.php?contextid=' + M.cfg.contextid;\n                        req[0].done(function (result) {\n                            if (result !== true) {\n                                window.location.href = redirecturl;\n                            } else if (wantsurl) {\n                                window.location.href = wantsurl;\n                            }\n                        }).fail(function () {\n                            window.location.href = redirecturl;\n                        });\n                    }\n                });\n            } else if (requiremonetization) {\n                var redirecturl = M.cfg.wwwroot + '/local/webmonetization/failed.php?contextid=' + M.cfg.contextid;\n                window.location.href = redirecturl;\n            }\n        }\n    };\n});\n"],"file":"handlereceipts.min.js"}